<!doctype html>
<html>
<head>
<meta charset="utf-moveSpeed">
<title>Tic-A-Tac Poker</title>
<link href="http://fonts.googleapis.com/css?family=Lilita+One" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="theme.css" media="all">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script>
<script src="ai.js"></script>
<script src="card.js"></script>
<script src="class.js"></script>
<script src="handler.js"></script>
<script src="render.js"></script>
<script>
//Constant////////////////////////////////////////
SPADE_SUIT = 0;
CLUB_SUIT = 1;
HEART_SUIT = 2;
DIAMOND_SUIT = 3;
SPECIAL_SUIT = 4;
CLOWN_RANK = 0;
THIEF_RANK = 1;
TORCH_RANK = 2;

ROYAL_FLUSH = 6;
STRAIGHT_FLUSH = 5;
FLUSH = 4;
STRAIGHT = 3;
THREE_OF_A_KIND = 2;
PAIR = 1;
//Game resource///////////////////////////////////
image = new Image();
image.src = "image.png";
image.onload = init;
//////////////////////////////////////////////////
function init(){
	deck = new Deck();
	dealtCards = new Array();
	for (var i = 0; i < 6; i++)
		if (!dealtCards[i]) dealtCards[i] = deck.dealCard();
	dealtCardIndex = 5;
	
	player = new Player("Human",115);
	ai = new Player("Computer",545);
	
	//Get the canvas
	animation = $("#animation")[0].getContext && $("#animation")[0].getContext("2d");
	board = $("#board")[0].getContext && $("#board")[0].getContext("2d");
	surface = $("#surface")[0].getContext && $("#surface")[0].getContext("2d");
	
	//Add event handlers
	$("#surface").mousedown(mouseDownHandler);
	$("#surface").mousemove(mouseMoveHandler);
	$("#surface").mouseout(mouseOutHandler);
	$("#surface").mouseup(mouseUpHandler);
	
	playerTurn = true;
	arrowRotateDegree = 90;
	
	inGame = true;
	gameLoop();
}

function gameLoop(){
	if ((!dealtCards[dealtCardIndex] || dealtCards[dealtCardIndex].scale >= 1) &&
		(playerTurn && arrowRotateDegree%360 == 0 || !playerTurn && arrowRotateDegree%360 == 180)) {
		//Player
		if (playerTurn)
			//Pass the turn
			if (player.move && player.noOfCard >= 9) {
				player.move = false;
				player.decision = "end";
				
				//......
			}
		
		//AI
		if (!playerTurn) {
			//Pass the turn
			if (ai.move && ai.noOfCard >= 9) {
				ai.move = false;
				ai.decision = "end";
				
				//......
			}
			
			if (!ai.decision) {
				ai.decision = aiAction();
				
				focusCardIndex = ai.decision.focusCardIndex;
				dealtCards[focusCardIndex].posX = 210+focusCardIndex*90;
				dealtCards[focusCardIndex].posY = 520;
			}
			
			var moveSpeed = 10;
			if (dealtCards[focusCardIndex] && dealtCards[focusCardIndex].scale == 1) {
				//Move the cursor
				var moveAngle = Math.abs(Math.atan((ai.mouseY-dealtCards[focusCardIndex].posY-42)/(ai.mouseX-dealtCards[focusCardIndex].posX-42)));
				if (ai.mouseX < dealtCards[focusCardIndex].posX+42) ai.mouseX += Math.floor(moveSpeed*Math.cos(moveAngle));
				if (ai.mouseX > dealtCards[focusCardIndex].posX+42) ai.mouseX -= Math.floor(moveSpeed*Math.cos(moveAngle));
				if (ai.mouseY < dealtCards[focusCardIndex].posY+42) ai.mouseY += Math.floor(moveSpeed*Math.sin(moveAngle));
				if (ai.mouseY > dealtCards[focusCardIndex].posY+42) ai.mouseY -= Math.floor(moveSpeed*Math.sin(moveAngle));
				
				//Arrive to the card
				if (ai.mouseX > dealtCards[focusCardIndex].posX+42-moveSpeed && ai.mouseX < dealtCards[focusCardIndex].posX+42+moveSpeed &&
					ai.mouseY > dealtCards[focusCardIndex].posY+42-moveSpeed && ai.mouseY < dealtCards[focusCardIndex].posY+42+moveSpeed)
					dealtCards[focusCardIndex].scale = 1.1;
			}
			
			if (dealtCards[focusCardIndex] && dealtCards[focusCardIndex].scale == 1.1) {
				//Move the card
				var moveAngle = Math.abs(Math.atan((dealtCards[focusCardIndex].posY-ai.decision.destPos.y)/(dealtCards[focusCardIndex].posX-ai.decision.destPos.x)));
				if (dealtCards[focusCardIndex].posX < ai.decision.destPos.x) {
					dealtCards[focusCardIndex].posX += Math.floor(moveSpeed*Math.cos(moveAngle));
					ai.mouseX += Math.floor(moveSpeed*Math.cos(moveAngle));
				}
				if (dealtCards[focusCardIndex].posX > ai.decision.destPos.x) {
					dealtCards[focusCardIndex].posX -= Math.floor(moveSpeed*Math.cos(moveAngle));
					ai.mouseX -= Math.floor(moveSpeed*Math.cos(moveAngle));
				}
				if (dealtCards[focusCardIndex].posY < ai.decision.destPos.y) {
					dealtCards[focusCardIndex].posY += Math.floor(moveSpeed*Math.sin(moveAngle));
					ai.mouseY += Math.floor(moveSpeed*Math.sin(moveAngle));
				}
				if (dealtCards[focusCardIndex].posY > ai.decision.destPos.y) {
					dealtCards[focusCardIndex].posY -= Math.floor(moveSpeed*Math.sin(moveAngle));
					ai.mouseY -= Math.floor(moveSpeed*Math.sin(moveAngle));
				}
				
				//Arrive to the destination
				if (dealtCards[focusCardIndex].posX > ai.decision.destPos.x-moveSpeed && dealtCards[focusCardIndex].posX < ai.decision.destPos.x+moveSpeed &&
					dealtCards[focusCardIndex].posY > ai.decision.destPos.y-moveSpeed && dealtCards[focusCardIndex].posY < ai.decision.destPos.y+moveSpeed) {
					//Poker, clown or torch to AI
					if (dealtCards[focusCardIndex].suit != SPECIAL_SUIT || dealtCards[focusCardIndex].suit == SPECIAL_SUIT &&
						(dealtCards[focusCardIndex].rank == CLOWN_RANK || dealtCards[focusCardIndex].rank == TORCH_RANK && ai.decision.burnTarget == "ai")) {
						ai.updateGrid(ai.decision.destPos.pos,dealtCards[focusCardIndex]);
						
						aniClear();
						aniShow = setInterval("aniDropCardEffect(ai.gridPosX,ai.decision.destPos.pos)",20);
					}
					//Torch to player
					if (dealtCards[focusCardIndex].suit == SPECIAL_SUIT && dealtCards[focusCardIndex].rank == TORCH_RANK && ai.decision.burnTarget == "player") {
						player.updateGrid(ai.decision.destPos.pos,dealtCards[focusCardIndex]);
						
						aniClear();
						aniShow = setInterval("aniDropCardEffect(player.gridPosX,ai.decision.destPos.pos)",20);
					}
					//Thief
					if (dealtCards[focusCardIndex].suit == SPECIAL_SUIT && dealtCards[focusCardIndex].rank == THIEF_RANK) {
						dealtCards[focusCardIndex] = player.updateGrid(ai.decision.destPos.pos,dealtCards[focusCardIndex]);
						player.updateHands();
						
						ai.decision.destPos = ai.decision.stealToPos;
					} else {
						dealtCards[focusCardIndex] = null;
						focusCardIndex = -1;
					
						ai.move = false;
					}
				}
			}
		}
		
		if (playerTurn && player.decision == "end" || !playerTurn && ai.decision == "end") {
			//Refill card
			for (var i = 0; i < 6; i++)
				if (!dealtCards[i]) {
					dealtCards[i] = deck.dealCard();
					dealtCardIndex = i;
				}
			
			//Reset
			if (playerTurn) {
				ai.move = true;
				ai.decision = null;
			} else {
				player.move = true;
				player.decision = null;
			}
			playerTurn = !playerTurn;
			
			inGame = (player.noOfCard < 9 || ai.noOfCard < 9);
		}
	} else arrowRotateDegree += 10;
	
	renderBoard();
	renderSurface();
	
	if (inGame) setTimeout("gameLoop()",20);
	else endGame();
}

function endGame(){
	alert("END!");
}
</script>
</head>

<body>
<div>
	<canvas id="board" width="960" height="640"></canvas>
    <canvas id="animation" width="960" height="640"></canvas>
	<canvas id="surface" width="960" height="640"></canvas>
</div>
</body>
</html>
